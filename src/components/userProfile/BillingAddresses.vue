<script setup lang="ts">
import { useAuth } from '@/composables/useAuth'
import { ref, reactive } from 'vue'
import type { Address } from '@/interfaces/signUpFormInterfaces'
import type {
  BaseAddress,
  ClientResponse,
  Customer,
  MyCustomerUpdateAction,
} from '@commercetools/platform-sdk'
import { Button, InputText, Message, Select, useToast } from 'primevue'
import { Form, FormField, type FormSubmitEvent } from '@primevue/forms'
import Card from 'primevue/card'
import { personalDataValidator } from '@/services/PersonalDataValidator/PersonalDataValidator'
import { countriesSelect } from '@/consts/signUpFormConsts'
import { saveChanges } from '@/services/saveChanges/saveChanges'

const { getApiRoot } = useAuth()
const toast = useToast()

const billingAddressesHolder = ref<BaseAddress[]>([])
const defaultBillingAddress = reactive({
  streetName: '',
  streetNumber: '',
  country: '',
  postalCode: '',
  city: '',
})
const addNewAddressMode = ref(false)

function getCustomerData(response: ClientResponse) {
  const customerData: Customer = response.body
  const addressesList: BaseAddress[] = customerData.addresses
  const defaultBillingId = customerData.defaultBillingAddressId

  let billingIDs: string[] = []
  if (customerData.billingAddressIds) {
    billingIDs = customerData.billingAddressIds
  }
  addressesList.forEach((address: BaseAddress) => {
    if (address.id) {
      if (address.id === defaultBillingId) {
        Object.assign(defaultBillingAddress, address)
      }
      if (billingIDs.includes(address.id) && address.id !== defaultBillingId) {
        billingAddressesHolder.value.push(address)
      }
    }
  })
}

function addNewAddressHandler() {
  addNewAddressMode.value = !addNewAddressMode.value
}
async function saveNewAddress(event: FormSubmitEvent) {
  try {
    if (event.valid) {
      const newAddress: Address = {
        city: event.states.city.value,
        country: event.states.country.value.code,
        streetName: event.states.street.value,
        streetNumber: event.states.streetNumber.value,
        postalCode: event.states.postalCode.value,
      }

      const actionAddAddress: MyCustomerUpdateAction = { action: 'addAddress', address: newAddress }
      const res = await saveChanges([actionAddAddress])
      const newAddressId = res.body.addresses[res.body.addresses.length - 1].id
      const actionAddId: MyCustomerUpdateAction = {
        action: 'addBillingAddressId',
        addressId: newAddressId,
      }
      await saveChanges([actionAddId])
      billingAddressesHolder.value.push(newAddress)
      toast.add({
        severity: 'success',
        summary: `Add ${newAddress.country}, ${newAddress.city}, ${newAddress.streetName}, ${newAddress.streetNumber} in billing addresses`,
        life: 5000,
      })
      event.reset()
    }
  } catch (error) {
    if (error instanceof Error) {
      toast.add({ severity: 'error', summary: `${error.message}`, life: 5000 })
    }
  }
}
async function deleteAddress(id: string) {
  try {
    const changes: MyCustomerUpdateAction[] = []
    changes.push({ action: 'removeBillingAddressId', addressId: id })
    changes.push({ action: 'removeAddress', addressId: id })
    await saveChanges(changes)
    billingAddressesHolder.value = billingAddressesHolder.value.filter((elem) => elem.id !== id)
  } catch (error) {
    if (error instanceof Error) {
      toast.add({ severity: 'error', summary: `${error.message}`, life: 5000 })
    }
  }
}
getApiRoot()
  .me()
  .get()
  .execute()
  .then((res) => {
    getCustomerData(res)
  })
</script>

<template>
  <section class="billing-addresses">
    <Card class="default address">
      <template #title>Default Address</template>
      <template #content>
        <p>
          {{
            `${defaultBillingAddress.country}, ${defaultBillingAddress.city}, ${defaultBillingAddress.streetName}, ${defaultBillingAddress.streetNumber}, ZIP ${defaultBillingAddress.postalCode}`
          }}
        </p>
      </template>
      <template #footer>
        <div class="control-buttons">
          <Button label="Edit" severity="contrast" outlined class="w-full"
            ><span class="pi pi-pencil"></span
          ></Button>
          <Button label="Delete" severity="danger" class="w-full"
            ><span class="pi pi-trash"></span
          ></Button>
        </div>
      </template>
    </Card>
    <h2>Other addresses</h2>
    <Card v-for="address in billingAddressesHolder" :key="address.id" class="address">
      <template #content>
        <h4>
          {{
            `${address.country}, ${address.city}, ${address.streetName}, ${address.streetNumber}, ZIP ${address.postalCode}`
          }}
        </h4>
      </template>
      <template #footer>
        <div class="control-buttons">
          <Button label="Edit" severity="contrast" outlined class="w-full"
            ><span class="pi pi-pencil"></span
          ></Button>
          <Button
            label="Delete"
            severity="danger"
            class="w-full"
            @click="
              () => {
                if (address.id) {
                  deleteAddress(address.id)
                }
              }
            "
            ><span class="pi pi-trash"></span
          ></Button>
        </div>
      </template>
    </Card>
    <Card class="add-address address">
      <template #title> Add new billing address</template>
      <template #content>
        <Form
          v-if="addNewAddressMode"
          v-slot="$form"
          @submit="saveNewAddress"
          :resolver="personalDataValidator"
          class="edit-form"
        >
          <FormField name="country">
            <Select
              :options="countriesSelect"
              optionLabel="name"
              placeholder="Select a Country"
              :manualInput="false"
              class="select-country-input"
            ></Select>
            <Message
              class="validation-error-message"
              v-if="$form.country?.invalid"
              severity="error"
              size="small"
              variant="simple"
              >{{ $form.country.error?.message }}</Message
            >
          </FormField>
          <FormField>
            <InputText class="input-city" name="city" placeholder="Enter city" />
            <Message
              class="validation-error-message"
              v-if="$form.city?.invalid"
              severity="error"
              size="small"
              variant="simple"
            >
              {{ $form.city.error?.message }}
            </Message>
          </FormField>
          <FormField>
            <InputText class="input-street" name="street" placeholder="Enter street name" />
            <Message
              class="validation-error-message"
              v-if="$form.street?.invalid"
              severity="error"
              size="small"
              variant="simple"
            >
              {{ $form.street.error?.message }}
            </Message>
          </FormField>
          <FormField>
            <InputText
              class="input-street-number"
              name="streetNumber"
              placeholder="Enter street number"
            />
            <Message
              class="validation-error-message"
              v-if="$form.streetNumber?.invalid"
              severity="error"
              size="small"
              variant="simple"
            >
              {{ $form.streetNumber.error?.message }}
            </Message>
          </FormField>
          <FormField>
            <InputText
              class="input-postal-code"
              name="postalCode"
              placeholder="Enter postal code/ZIP"
            />
            <Message
              class="validation-error-message"
              v-if="$form.postalCode?.invalid"
              severity="error"
              size="small"
              variant="simple"
            >
              {{ $form.postalCode.error?.message }}
            </Message>
          </FormField>
          <div class="control-buttons">
            <Button label="Save" severity="success" outlined type="submit" class="w-full"
              ><span class="pi pi-check"></span
            ></Button>
            <Button label="Cancel" severity="danger" class="w-full" @click="addNewAddressHandler"
              ><span class="pi pi-times"></span
            ></Button>
          </div>
        </Form>
      </template>
      <template #footer>
        <Button
          label="Add"
          severity="contrast"
          outlined
          class="w-full"
          v-if="!addNewAddressMode"
          @click="addNewAddressHandler"
          ><span class="pi pi-plus"></span
        ></Button>
      </template>
    </Card>
  </section>
</template>
<style scoped>
.billing-addresses {
  display: flex;
  flex-direction: column;
  gap: 5px 0;
}
.address {
  overflow: hidden;
  background-color: rgba(255, 255, 255, 0.064);
}

.edit-form {
  display: flex;
  flex-direction: column;
  gap: 10px 0;
}

input,
.select-country-input {
  width: 100%;
}
.control-buttons {
  display: flex;
  gap: 0 10px;
}
@media (min-width: 700px) {
  input,
  .select-country-input {
    width: 50%;
  }
}
</style>
